(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();const bt=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function se(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function Se(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function pt(t,...e){if(!se(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function hn(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Se(t.outputLen),Se(t.blockLen)}function Ft(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function _r(t,e){pt(t);const r=e.outputLen;if(t.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}function Gt(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function pe(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function W(t,e){return t<<32-e|t>>>e}const gn=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Br=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function J(t){if(pt(t),gn)return t.toHex();let e="";for(let r=0;r<t.length;r++)e+=Br[t[r]];return e}const Q={_0:48,_9:57,A:65,F:70,a:97,f:102};function Je(t){if(t>=Q._0&&t<=Q._9)return t-Q._0;if(t>=Q.A&&t<=Q.F)return t-(Q.A-10);if(t>=Q.a&&t<=Q.f)return t-(Q.a-10)}function _t(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(gn)return Uint8Array.fromHex(t);const e=t.length,r=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(r);for(let s=0,o=0;s<r;s++,o+=2){const i=Je(t.charCodeAt(o)),a=Je(t.charCodeAt(o+1));if(i===void 0||a===void 0){const l=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}n[s]=i*16+a}return n}function oe(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function Te(t){return typeof t=="string"&&(t=oe(t)),pt(t),t}function X(...t){let e=0;for(let n=0;n<t.length;n++){const s=t[n];pt(s),e+=s.length}const r=new Uint8Array(e);for(let n=0,s=0;n<t.length;n++){const o=t[n];r.set(o,s),s+=o.length}return r}class pn{}function Sr(t){const e=n=>t().update(Te(n)).digest(),r=t();return e.outputLen=r.outputLen,e.blockLen=r.blockLen,e.create=()=>t(),e}function ie(t=32){if(bt&&typeof bt.getRandomValues=="function")return bt.getRandomValues(new Uint8Array(t));if(bt&&typeof bt.randomBytes=="function")return Uint8Array.from(bt.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function kr(t,e,r,n){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,r,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(r>>s&o),a=Number(r&o),l=n?4:0,m=n?0:4;t.setUint32(e+l,i,n),t.setUint32(e+m,a,n)}function Ir(t,e,r){return t&e^~t&r}function Rr(t,e,r){return t&e^t&r^e&r}class Nr extends pn{constructor(e,r,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=r,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=pe(this.buffer)}update(e){Ft(this),e=Te(e),pt(e);const{view:r,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){const a=Math.min(s-this.pos,o-i);if(a===s){const l=pe(e);for(;s<=o-i;i+=s)this.process(l,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(r,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ft(this),_r(e,this),this.finished=!0;const{buffer:r,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;r[i++]=128,Gt(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let y=i;y<s;y++)r[y]=0;kr(n,s-8,BigInt(this.length*8),o),this.process(n,0);const a=pe(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const m=l/4,p=this.get();if(m>p.length)throw new Error("_sha2: outputLen bigger than state");for(let y=0;y<m;y++)a.setUint32(4*y,p[y],o)}digest(){const{buffer:e,outputLen:r}=this;this.digestInto(e);const n=e.slice(0,r);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:r,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%r&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const ct=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Cr=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),at=new Uint32Array(64);class Ar extends Nr{constructor(e=32){super(64,e,8,!1),this.A=ct[0]|0,this.B=ct[1]|0,this.C=ct[2]|0,this.D=ct[3]|0,this.E=ct[4]|0,this.F=ct[5]|0,this.G=ct[6]|0,this.H=ct[7]|0}get(){const{A:e,B:r,C:n,D:s,E:o,F:i,G:a,H:l}=this;return[e,r,n,s,o,i,a,l]}set(e,r,n,s,o,i,a,l){this.A=e|0,this.B=r|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=l|0}process(e,r){for(let y=0;y<16;y++,r+=4)at[y]=e.getUint32(r,!1);for(let y=16;y<64;y++){const u=at[y-15],f=at[y-2],b=W(u,7)^W(u,18)^u>>>3,v=W(f,17)^W(f,19)^f>>>10;at[y]=v+at[y-7]+b+at[y-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:l,G:m,H:p}=this;for(let y=0;y<64;y++){const u=W(a,6)^W(a,11)^W(a,25),f=p+u+Ir(a,l,m)+Cr[y]+at[y]|0,v=(W(n,2)^W(n,13)^W(n,22))+Rr(n,s,o)|0;p=m,m=l,l=a,a=i+f|0,i=o,o=s,s=n,n=f+v|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,l=l+this.F|0,m=m+this.G|0,p=p+this.H|0,this.set(n,s,o,i,a,l,m,p)}roundClean(){Gt(at)}destroy(){this.set(0,0,0,0,0,0,0,0),Gt(this.buffer)}}const Jt=Sr(()=>new Ar),yn=Jt;class wn extends pn{constructor(e,r){super(),this.finished=!1,this.destroyed=!1,hn(e);const n=Te(r);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),Gt(o)}update(e){return Ft(this),this.iHash.update(e),this}digestInto(e){Ft(this),pt(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:r,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=r._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const bn=(t,e,r)=>new wn(t,e).update(r).digest();bn.create=(t,e)=>new wn(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const He=BigInt(0),ke=BigInt(1);function Wt(t,e=""){if(typeof t!="boolean"){const r=e&&`"${e}"`;throw new Error(r+"expected boolean, got type="+typeof t)}return t}function dt(t,e,r=""){const n=se(t),s=t==null?void 0:t.length,o=e!==void 0;if(!n||o&&s!==e){const i=r&&`"${r}" `,a=o?` of length ${e}`:"",l=n?`length=${s}`:`type=${typeof t}`;throw new Error(i+"expected Uint8Array"+a+", got "+l)}return t}function jt(t){const e=t.toString(16);return e.length&1?"0"+e:e}function En(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?He:BigInt("0x"+t)}function It(t){return En(J(t))}function xn(t){return pt(t),En(J(Uint8Array.from(t).reverse()))}function ce(t,e){return _t(t.toString(16).padStart(e*2,"0"))}function vn(t,e){return ce(t,e).reverse()}function q(t,e,r){let n;if(typeof e=="string")try{n=_t(e)}catch(o){throw new Error(t+" must be hex string or Uint8Array, cause: "+o)}else if(se(e))n=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const s=n.length;if(typeof r=="number"&&s!==r)throw new Error(t+" of length "+r+" expected, got "+s);return n}const ye=t=>typeof t=="bigint"&&He<=t;function Ie(t,e,r){return ye(t)&&ye(e)&&ye(r)&&e<=t&&t<r}function Lr(t,e,r,n){if(!Ie(e,r,n))throw new Error("expected valid "+t+": "+r+" <= n < "+n+", got "+e)}function _n(t){let e;for(e=0;t>He;t>>=ke,e+=1);return e}const Ut=t=>(ke<<BigInt(t))-ke;function Or(t,e,r){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof r!="function")throw new Error("hmacFn must be a function");const n=f=>new Uint8Array(f),s=f=>Uint8Array.of(f);let o=n(t),i=n(t),a=0;const l=()=>{o.fill(1),i.fill(0),a=0},m=(...f)=>r(i,o,...f),p=(f=n(0))=>{i=m(s(0),f),o=m(),f.length!==0&&(i=m(s(1),f),o=m())},y=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let f=0;const b=[];for(;f<e;){o=m();const v=o.slice();b.push(v),f+=o.length}return X(...b)};return(f,b)=>{l(),p(f);let v;for(;!(v=b(y()));)p();return l(),v}}function Me(t,e,r={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function n(s,o,i){const a=t[s];if(i&&a===void 0)return;const l=typeof a;if(l!==o||a===null)throw new Error(`param "${s}" is invalid: expected ${o}, got ${l}`)}Object.entries(e).forEach(([s,o])=>n(s,o,!1)),Object.entries(r).forEach(([s,o])=>n(s,o,!0))}function We(t){const e=new WeakMap;return(r,...n)=>{const s=e.get(r);if(s!==void 0)return s;const o=t(r,...n);return e.set(r,o),o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const j=BigInt(0),V=BigInt(1),mt=BigInt(2),Bn=BigInt(3),Sn=BigInt(4),kn=BigInt(5),Tr=BigInt(7),In=BigInt(8),Hr=BigInt(9),Rn=BigInt(16);function G(t,e){const r=t%e;return r>=j?r:e+r}function F(t,e,r){let n=t;for(;e-- >j;)n*=n,n%=r;return n}function Xe(t,e){if(t===j)throw new Error("invert: expected non-zero number");if(e<=j)throw new Error("invert: expected positive modulus, got "+e);let r=G(t,e),n=e,s=j,o=V;for(;r!==j;){const a=n/r,l=n%r,m=s-o*a;n=r,r=l,s=o,o=m}if(n!==V)throw new Error("invert: does not exist");return G(s,e)}function $e(t,e,r){if(!t.eql(t.sqr(e),r))throw new Error("Cannot find square root")}function Nn(t,e){const r=(t.ORDER+V)/Sn,n=t.pow(e,r);return $e(t,n,e),n}function Mr(t,e){const r=(t.ORDER-kn)/In,n=t.mul(e,mt),s=t.pow(n,r),o=t.mul(e,s),i=t.mul(t.mul(o,mt),s),a=t.mul(o,t.sub(i,t.ONE));return $e(t,a,e),a}function $r(t){const e=qt(t),r=Cn(t),n=r(e,e.neg(e.ONE)),s=r(e,n),o=r(e,e.neg(n)),i=(t+Tr)/Rn;return(a,l)=>{let m=a.pow(l,i),p=a.mul(m,n);const y=a.mul(m,s),u=a.mul(m,o),f=a.eql(a.sqr(p),l),b=a.eql(a.sqr(y),l);m=a.cmov(m,p,f),p=a.cmov(u,y,b);const v=a.eql(a.sqr(p),l),A=a.cmov(m,p,v);return $e(a,A,l),A}}function Cn(t){if(t<Bn)throw new Error("sqrt is not defined for small field");let e=t-V,r=0;for(;e%mt===j;)e/=mt,r++;let n=mt;const s=qt(t);for(;Qe(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(r===1)return Nn;let o=s.pow(n,e);const i=(e+V)/mt;return function(l,m){if(l.is0(m))return m;if(Qe(l,m)!==1)throw new Error("Cannot find square root");let p=r,y=l.mul(l.ONE,o),u=l.pow(m,e),f=l.pow(m,i);for(;!l.eql(u,l.ONE);){if(l.is0(u))return l.ZERO;let b=1,v=l.sqr(u);for(;!l.eql(v,l.ONE);)if(b++,v=l.sqr(v),b===p)throw new Error("Cannot find square root");const A=V<<BigInt(p-b-1),O=l.pow(y,A);p=b,y=l.sqr(O),u=l.mul(u,y),f=l.mul(f,O)}return f}}function Ur(t){return t%Sn===Bn?Nn:t%In===kn?Mr:t%Rn===Hr?$r(t):Cn(t)}const qr=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Pr(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},r=qr.reduce((n,s)=>(n[s]="function",n),e);return Me(t,r),t}function Kr(t,e,r){if(r<j)throw new Error("invalid exponent, negatives unsupported");if(r===j)return t.ONE;if(r===V)return e;let n=t.ONE,s=e;for(;r>j;)r&V&&(n=t.mul(n,s)),s=t.sqr(s),r>>=V;return n}function An(t,e,r=!1){const n=new Array(e.length).fill(r?t.ZERO:void 0),s=e.reduce((i,a,l)=>t.is0(a)?i:(n[l]=i,t.mul(i,a)),t.ONE),o=t.inv(s);return e.reduceRight((i,a,l)=>t.is0(a)?i:(n[l]=t.mul(i,n[l]),t.mul(i,a)),o),n}function Qe(t,e){const r=(t.ORDER-V)/mt,n=t.pow(e,r),s=t.eql(n,t.ONE),o=t.eql(n,t.ZERO),i=t.eql(n,t.neg(t.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function Ln(t,e){e!==void 0&&Se(e);const r=e!==void 0?e:t.toString(2).length,n=Math.ceil(r/8);return{nBitLength:r,nByteLength:n}}function qt(t,e,r=!1,n={}){if(t<=j)throw new Error("invalid field: expected ORDER > 0, got "+t);let s,o,i=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||r)throw new Error("cannot specify opts in two arguments");const u=e;u.BITS&&(s=u.BITS),u.sqrt&&(o=u.sqrt),typeof u.isLE=="boolean"&&(r=u.isLE),typeof u.modFromBytes=="boolean"&&(i=u.modFromBytes),a=u.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(o=n.sqrt);const{nBitLength:l,nByteLength:m}=Ln(t,s);if(m>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let p;const y=Object.freeze({ORDER:t,isLE:r,BITS:l,BYTES:m,MASK:Ut(l),ZERO:j,ONE:V,allowedLengths:a,create:u=>G(u,t),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return j<=u&&u<t},is0:u=>u===j,isValidNot0:u=>!y.is0(u)&&y.isValid(u),isOdd:u=>(u&V)===V,neg:u=>G(-u,t),eql:(u,f)=>u===f,sqr:u=>G(u*u,t),add:(u,f)=>G(u+f,t),sub:(u,f)=>G(u-f,t),mul:(u,f)=>G(u*f,t),pow:(u,f)=>Kr(y,u,f),div:(u,f)=>G(u*Xe(f,t),t),sqrN:u=>u*u,addN:(u,f)=>u+f,subN:(u,f)=>u-f,mulN:(u,f)=>u*f,inv:u=>Xe(u,t),sqrt:o||(u=>(p||(p=Ur(t)),p(y,u))),toBytes:u=>r?vn(u,m):ce(u,m),fromBytes:(u,f=!0)=>{if(a){if(!a.includes(u.length)||u.length>m)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+u.length);const v=new Uint8Array(m);v.set(u,r?0:v.length-u.length),u=v}if(u.length!==m)throw new Error("Field.fromBytes: expected "+m+" bytes, got "+u.length);let b=r?xn(u):It(u);if(i&&(b=G(b,t)),!f&&!y.isValid(b))throw new Error("invalid field element: outside of range 0..ORDER");return b},invertBatch:u=>An(y,u),cmov:(u,f,b)=>b?f:u});return Object.freeze(y)}function On(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function Tn(t){const e=On(t);return e+Math.ceil(e/2)}function Hn(t,e,r=!1){const n=t.length,s=On(e),o=Tn(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);const i=r?xn(t):It(t),a=G(i,e-V)+V;return r?vn(a,s):ce(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Bt=BigInt(0),ht=BigInt(1);function Xt(t,e){const r=e.negate();return t?r:e}function we(t,e){const r=An(t.Fp,e.map(n=>n.Z));return e.map((n,s)=>t.fromAffine(n.toAffine(r[s])))}function Mn(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function be(t,e){Mn(t,e);const r=Math.ceil(e/t)+1,n=2**(t-1),s=2**t,o=Ut(t),i=BigInt(t);return{windows:r,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function tn(t,e,r){const{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=r;let a=Number(t&s),l=t>>i;a>n&&(a-=o,l+=ht);const m=e*n,p=m+Math.abs(a)-1,y=a===0,u=a<0,f=e%2!==0;return{nextN:l,offset:p,isZero:y,isNeg:u,isNegF:f,offsetF:m}}function Vr(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((r,n)=>{if(!(r instanceof e))throw new Error("invalid point at index "+n)})}function Zr(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((r,n)=>{if(!e.isValid(r))throw new Error("invalid scalar at index "+n)})}const Ee=new WeakMap,$n=new WeakMap;function xe(t){return $n.get(t)||1}function en(t){if(t!==Bt)throw new Error("invalid wNAF")}class jr{constructor(e,r){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=r}_unsafeLadder(e,r,n=this.ZERO){let s=e;for(;r>Bt;)r&ht&&(n=n.add(s)),s=s.double(),r>>=ht;return n}precomputeWindow(e,r){const{windows:n,windowSize:s}=be(r,this.bits),o=[];let i=e,a=i;for(let l=0;l<n;l++){a=i,o.push(a);for(let m=1;m<s;m++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,r,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE;const i=be(e,this.bits);for(let a=0;a<i.windows;a++){const{nextN:l,offset:m,isZero:p,isNeg:y,isNegF:u,offsetF:f}=tn(n,a,i);n=l,p?o=o.add(Xt(u,r[f])):s=s.add(Xt(y,r[m]))}return en(n),{p:s,f:o}}wNAFUnsafe(e,r,n,s=this.ZERO){const o=be(e,this.bits);for(let i=0;i<o.windows&&n!==Bt;i++){const{nextN:a,offset:l,isZero:m,isNeg:p}=tn(n,i,o);if(n=a,!m){const y=r[l];s=s.add(p?y.negate():y)}}return en(n),s}getPrecomputes(e,r,n){let s=Ee.get(r);return s||(s=this.precomputeWindow(r,e),e!==1&&(typeof n=="function"&&(s=n(s)),Ee.set(r,s))),s}cached(e,r,n){const s=xe(e);return this.wNAF(s,this.getPrecomputes(s,e,n),r)}unsafe(e,r,n,s){const o=xe(e);return o===1?this._unsafeLadder(e,r,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),r,s)}createCache(e,r){Mn(r,this.bits),$n.set(e,r),Ee.delete(e)}hasCache(e){return xe(e)!==1}}function zr(t,e,r,n){let s=e,o=t.ZERO,i=t.ZERO;for(;r>Bt||n>Bt;)r&ht&&(o=o.add(s)),n&ht&&(i=i.add(s)),s=s.double(),r>>=ht,n>>=ht;return{p1:o,p2:i}}function Dr(t,e,r,n){Vr(r,t),Zr(n,e);const s=r.length,o=n.length;if(s!==o)throw new Error("arrays of points and scalars must have equal length");const i=t.ZERO,a=_n(BigInt(s));let l=1;a>12?l=a-3:a>4?l=a-2:a>0&&(l=2);const m=Ut(l),p=new Array(Number(m)+1).fill(i),y=Math.floor((e.BITS-1)/l)*l;let u=i;for(let f=y;f>=0;f-=l){p.fill(i);for(let v=0;v<o;v++){const A=n[v],O=Number(A>>BigInt(f)&m);p[O]=p[O].add(r[v])}let b=i;for(let v=p.length-1,A=i;v>0;v--)A=A.add(p[v]),b=b.add(A);if(u=u.add(b),f!==0)for(let v=0;v<l;v++)u=u.double()}return u}function nn(t,e,r){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Pr(e),e}else return qt(t,{isLE:r})}function Yr(t,e,r={},n){if(n===void 0&&(n=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const l of["p","n","h"]){const m=e[l];if(!(typeof m=="bigint"&&m>Bt))throw new Error(`CURVE.${l} must be positive bigint`)}const s=nn(e.p,r.Fp,n),o=nn(e.n,r.Fn,n),a=["Gx","Gy","a","b"];for(const l of a)if(!s.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const rn=(t,e)=>(t+(t>=0?e:-e)/Un)/e;function Fr(t,e,r){const[[n,s],[o,i]]=e,a=rn(i*t,r),l=rn(-s*t,r);let m=t-a*n-l*o,p=-a*s-l*i;const y=m<nt,u=p<nt;y&&(m=-m),u&&(p=-p);const f=Ut(Math.ceil(_n(r)/2))+xt;if(m<nt||m>=f||p<nt||p>=f)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:y,k1:m,k2neg:u,k2:p}}function Re(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function ve(t,e){const r={};for(let n of Object.keys(e))r[n]=t[n]===void 0?e[n]:t[n];return Wt(r.lowS,"lowS"),Wt(r.prehash,"prehash"),r.format!==void 0&&Re(r.format),r}class Gr extends Error{constructor(e=""){super(e)}}const tt={Err:Gr,_tlv:{encode:(t,e)=>{const{Err:r}=tt;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length&1)throw new r("tlv.encode: unpadded data");const n=e.length/2,s=jt(n);if(s.length/2&128)throw new r("tlv.encode: long form length too big");const o=n>127?jt(s.length/2|128):"";return jt(t)+o+s+e},decode(t,e){const{Err:r}=tt;let n=0;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new r("tlv.decode: wrong tlv");const s=e[n++],o=!!(s&128);let i=0;if(!o)i=s;else{const l=s&127;if(!l)throw new r("tlv.decode(long): indefinite length not supported");if(l>4)throw new r("tlv.decode(long): byte length is too big");const m=e.subarray(n,n+l);if(m.length!==l)throw new r("tlv.decode: length bytes not complete");if(m[0]===0)throw new r("tlv.decode(long): zero leftmost byte");for(const p of m)i=i<<8|p;if(n+=l,i<128)throw new r("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+i);if(a.length!==i)throw new r("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(t){const{Err:e}=tt;if(t<nt)throw new e("integer: negative integers are not allowed");let r=jt(t);if(Number.parseInt(r[0],16)&8&&(r="00"+r),r.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return r},decode(t){const{Err:e}=tt;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return It(t)}},toSig(t){const{Err:e,_int:r,_tlv:n}=tt,s=q("signature",t),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l}=n.decode(2,o),{v:m,l:p}=n.decode(2,l);if(p.length)throw new e("invalid signature: left bytes after parsing");return{r:r.decode(a),s:r.decode(m)}},hexFromSig(t){const{_tlv:e,_int:r}=tt,n=e.encode(2,r.encode(t.r)),s=e.encode(2,r.encode(t.s)),o=n+s;return e.encode(48,o)}},nt=BigInt(0),xt=BigInt(1),Un=BigInt(2),zt=BigInt(3),Jr=BigInt(4);function gt(t,e){const{BYTES:r}=t;let n;if(typeof e=="bigint")n=e;else{let s=q("private key",e);try{n=t.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${r}, got ${typeof e}`)}}if(!t.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function Wr(t,e={}){const r=Yr("weierstrass",t,e),{Fp:n,Fn:s}=r;let o=r.CURVE;const{h:i,n:a}=o;Me(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!n.is0(o.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const m=Pn(n,s);function p(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function y(C,g,h){const{x:d,y:w}=g.toAffine(),E=n.toBytes(d);if(Wt(h,"isCompressed"),h){p();const S=!n.isOdd(w);return X(qn(S),E)}else return X(Uint8Array.of(4),E,n.toBytes(w))}function u(C){dt(C,void 0,"Point");const{publicKey:g,publicKeyUncompressed:h}=m,d=C.length,w=C[0],E=C.subarray(1);if(d===g&&(w===2||w===3)){const S=n.fromBytes(E);if(!n.isValid(S))throw new Error("bad point: is not on curve, wrong x");const _=v(S);let x;try{x=n.sqrt(_)}catch($){const L=$ instanceof Error?": "+$.message:"";throw new Error("bad point: is not on curve, sqrt error"+L)}p();const k=n.isOdd(x);return(w&1)===1!==k&&(x=n.neg(x)),{x:S,y:x}}else if(d===h&&w===4){const S=n.BYTES,_=n.fromBytes(E.subarray(0,S)),x=n.fromBytes(E.subarray(S,S*2));if(!A(_,x))throw new Error("bad point: is not on curve");return{x:_,y:x}}else throw new Error(`bad point: got length ${d}, expected compressed=${g} or uncompressed=${h}`)}const f=e.toBytes||y,b=e.fromBytes||u;function v(C){const g=n.sqr(C),h=n.mul(g,C);return n.add(n.add(h,n.mul(C,o.a)),o.b)}function A(C,g){const h=n.sqr(g),d=v(C);return n.eql(h,d)}if(!A(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const O=n.mul(n.pow(o.a,zt),Jr),Nt=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(O,Nt)))throw new Error("bad curve params: a or b");function M(C,g,h=!1){if(!n.isValid(g)||h&&n.is0(g))throw new Error(`bad point coordinate ${C}`);return g}function ut(C){if(!(C instanceof R))throw new Error("ProjectivePoint expected")}function it(C){if(!l||!l.basises)throw new Error("no endo");return Fr(C,l.basises,s.ORDER)}const yt=We((C,g)=>{const{X:h,Y:d,Z:w}=C;if(n.eql(w,n.ONE))return{x:h,y:d};const E=C.is0();g==null&&(g=E?n.ONE:n.inv(w));const S=n.mul(h,g),_=n.mul(d,g),x=n.mul(w,g);if(E)return{x:n.ZERO,y:n.ZERO};if(!n.eql(x,n.ONE))throw new Error("invZ was invalid");return{x:S,y:_}}),Kt=We(C=>{if(C.is0()){if(e.allowInfinityPoint&&!n.is0(C.Y))return;throw new Error("bad point: ZERO")}const{x:g,y:h}=C.toAffine();if(!n.isValid(g)||!n.isValid(h))throw new Error("bad point: x or y not field elements");if(!A(g,h))throw new Error("bad point: equation left != right");if(!C.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function wt(C,g,h,d,w){return h=new R(n.mul(h.X,C),h.Y,h.Z),g=Xt(d,g),h=Xt(w,h),g.add(h)}class R{constructor(g,h,d){this.X=M("x",g),this.Y=M("y",h,!0),this.Z=M("z",d),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){const{x:h,y:d}=g||{};if(!g||!n.isValid(h)||!n.isValid(d))throw new Error("invalid affine point");if(g instanceof R)throw new Error("projective point not allowed");return n.is0(h)&&n.is0(d)?R.ZERO:new R(h,d,n.ONE)}static fromBytes(g){const h=R.fromAffine(b(dt(g,void 0,"point")));return h.assertValidity(),h}static fromHex(g){return R.fromBytes(q("pointHex",g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,h=!0){return ft.createCache(this,g),h||this.multiply(zt),this}assertValidity(){Kt(this)}hasEvenY(){const{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){ut(g);const{X:h,Y:d,Z:w}=this,{X:E,Y:S,Z:_}=g,x=n.eql(n.mul(h,_),n.mul(E,w)),k=n.eql(n.mul(d,_),n.mul(S,w));return x&&k}negate(){return new R(this.X,n.neg(this.Y),this.Z)}double(){const{a:g,b:h}=o,d=n.mul(h,zt),{X:w,Y:E,Z:S}=this;let _=n.ZERO,x=n.ZERO,k=n.ZERO,I=n.mul(w,w),$=n.mul(E,E),L=n.mul(S,S),N=n.mul(w,E);return N=n.add(N,N),k=n.mul(w,S),k=n.add(k,k),_=n.mul(g,k),x=n.mul(d,L),x=n.add(_,x),_=n.sub($,x),x=n.add($,x),x=n.mul(_,x),_=n.mul(N,_),k=n.mul(d,k),L=n.mul(g,L),N=n.sub(I,L),N=n.mul(g,N),N=n.add(N,k),k=n.add(I,I),I=n.add(k,I),I=n.add(I,L),I=n.mul(I,N),x=n.add(x,I),L=n.mul(E,S),L=n.add(L,L),I=n.mul(L,N),_=n.sub(_,I),k=n.mul(L,$),k=n.add(k,k),k=n.add(k,k),new R(_,x,k)}add(g){ut(g);const{X:h,Y:d,Z:w}=this,{X:E,Y:S,Z:_}=g;let x=n.ZERO,k=n.ZERO,I=n.ZERO;const $=o.a,L=n.mul(o.b,zt);let N=n.mul(h,E),T=n.mul(d,S),U=n.mul(w,_),Z=n.add(h,d),H=n.add(E,S);Z=n.mul(Z,H),H=n.add(N,T),Z=n.sub(Z,H),H=n.add(h,w);let K=n.add(E,_);return H=n.mul(H,K),K=n.add(N,U),H=n.sub(H,K),K=n.add(d,w),x=n.add(S,_),K=n.mul(K,x),x=n.add(T,U),K=n.sub(K,x),I=n.mul($,H),x=n.mul(L,U),I=n.add(x,I),x=n.sub(T,I),I=n.add(T,I),k=n.mul(x,I),T=n.add(N,N),T=n.add(T,N),U=n.mul($,U),H=n.mul(L,H),T=n.add(T,U),U=n.sub(N,U),U=n.mul($,U),H=n.add(H,U),N=n.mul(T,H),k=n.add(k,N),N=n.mul(K,H),x=n.mul(Z,x),x=n.sub(x,N),N=n.mul(Z,T),I=n.mul(K,I),I=n.add(I,N),new R(x,k,I)}subtract(g){return this.add(g.negate())}is0(){return this.equals(R.ZERO)}multiply(g){const{endo:h}=e;if(!s.isValidNot0(g))throw new Error("invalid scalar: out of range");let d,w;const E=S=>ft.cached(this,S,_=>we(R,_));if(h){const{k1neg:S,k1:_,k2neg:x,k2:k}=it(g),{p:I,f:$}=E(_),{p:L,f:N}=E(k);w=$.add(N),d=wt(h.beta,I,L,S,x)}else{const{p:S,f:_}=E(g);d=S,w=_}return we(R,[d,w])[0]}multiplyUnsafe(g){const{endo:h}=e,d=this;if(!s.isValid(g))throw new Error("invalid scalar: out of range");if(g===nt||d.is0())return R.ZERO;if(g===xt)return d;if(ft.hasCache(this))return this.multiply(g);if(h){const{k1neg:w,k1:E,k2neg:S,k2:_}=it(g),{p1:x,p2:k}=zr(R,d,E,_);return wt(h.beta,x,k,w,S)}else return ft.unsafe(d,g)}multiplyAndAddUnsafe(g,h,d){const w=this.multiplyUnsafe(h).add(g.multiplyUnsafe(d));return w.is0()?void 0:w}toAffine(g){return yt(this,g)}isTorsionFree(){const{isTorsionFree:g}=e;return i===xt?!0:g?g(R,this):ft.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:g}=e;return i===xt?this:g?g(R,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return Wt(g,"isCompressed"),this.assertValidity(),f(R,this,g)}toHex(g=!0){return J(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(g=!0){return this.toBytes(g)}_setWindowSize(g){this.precompute(g)}static normalizeZ(g){return we(R,g)}static msm(g,h){return Dr(R,s,g,h)}static fromPrivateKey(g){return R.BASE.multiply(gt(s,g))}}R.BASE=new R(o.Gx,o.Gy,n.ONE),R.ZERO=new R(n.ZERO,n.ONE,n.ZERO),R.Fp=n,R.Fn=s;const Vt=s.BITS,ft=new jr(R,e.endo?Math.ceil(Vt/2):Vt);return R.BASE.precompute(8),R}function qn(t){return Uint8Array.of(t?2:3)}function Pn(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Xr(t,e={}){const{Fn:r}=t,n=e.randomBytes||ie,s=Object.assign(Pn(t.Fp,r),{seed:Tn(r.ORDER)});function o(f){try{return!!gt(r,f)}catch{return!1}}function i(f,b){const{publicKey:v,publicKeyUncompressed:A}=s;try{const O=f.length;return b===!0&&O!==v||b===!1&&O!==A?!1:!!t.fromBytes(f)}catch{return!1}}function a(f=n(s.seed)){return Hn(dt(f,s.seed,"seed"),r.ORDER)}function l(f,b=!0){return t.BASE.multiply(gt(r,f)).toBytes(b)}function m(f){const b=a(f);return{secretKey:b,publicKey:l(b)}}function p(f){if(typeof f=="bigint")return!1;if(f instanceof t)return!0;const{secretKey:b,publicKey:v,publicKeyUncompressed:A}=s;if(r.allowedLengths||b===v)return;const O=q("key",f).length;return O===v||O===A}function y(f,b,v=!0){if(p(f)===!0)throw new Error("first arg must be private key");if(p(b)===!1)throw new Error("second arg must be public key");const A=gt(r,f);return t.fromHex(b).multiply(A).toBytes(v)}return Object.freeze({getPublicKey:l,getSharedSecret:y,keygen:m,Point:t,utils:{isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a,isValidPrivateKey:o,randomPrivateKey:a,normPrivateKeyToScalar:f=>gt(r,f),precompute(f=8,b=t.BASE){return b.precompute(f,!1)}},lengths:s})}function Qr(t,e,r={}){hn(e),Me(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=r.randomBytes||ie,s=r.hmac||((h,...d)=>bn(e,h,X(...d))),{Fp:o,Fn:i}=t,{ORDER:a,BITS:l}=i,{keygen:m,getPublicKey:p,getSharedSecret:y,utils:u,lengths:f}=Xr(t,r),b={prehash:!1,lowS:typeof r.lowS=="boolean"?r.lowS:!1,format:void 0,extraEntropy:!1},v="compact";function A(h){const d=a>>xt;return h>d}function O(h,d){if(!i.isValidNot0(d))throw new Error(`invalid signature ${h}: out of range 1..Point.Fn.ORDER`);return d}function Nt(h,d){Re(d);const w=f.signature,E=d==="compact"?w:d==="recovered"?w+1:void 0;return dt(h,E,`${d} signature`)}class M{constructor(d,w,E){this.r=O("r",d),this.s=O("s",w),E!=null&&(this.recovery=E),Object.freeze(this)}static fromBytes(d,w=v){Nt(d,w);let E;if(w==="der"){const{r:k,s:I}=tt.toSig(dt(d));return new M(k,I)}w==="recovered"&&(E=d[0],w="compact",d=d.subarray(1));const S=i.BYTES,_=d.subarray(0,S),x=d.subarray(S,S*2);return new M(i.fromBytes(_),i.fromBytes(x),E)}static fromHex(d,w){return this.fromBytes(_t(d),w)}addRecoveryBit(d){return new M(this.r,this.s,d)}recoverPublicKey(d){const w=o.ORDER,{r:E,s:S,recovery:_}=this;if(_==null||![0,1,2,3].includes(_))throw new Error("recovery id invalid");if(a*Un<w&&_>1)throw new Error("recovery id is ambiguous for h>1 curve");const k=_===2||_===3?E+a:E;if(!o.isValid(k))throw new Error("recovery id 2 or 3 invalid");const I=o.toBytes(k),$=t.fromBytes(X(qn((_&1)===0),I)),L=i.inv(k),N=it(q("msgHash",d)),T=i.create(-N*L),U=i.create(S*L),Z=t.BASE.multiplyUnsafe(T).add($.multiplyUnsafe(U));if(Z.is0())throw new Error("point at infinify");return Z.assertValidity(),Z}hasHighS(){return A(this.s)}toBytes(d=v){if(Re(d),d==="der")return _t(tt.hexFromSig(this));const w=i.toBytes(this.r),E=i.toBytes(this.s);if(d==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return X(Uint8Array.of(this.recovery),w,E)}return X(w,E)}toHex(d){return J(this.toBytes(d))}assertValidity(){}static fromCompact(d){return M.fromBytes(q("sig",d),"compact")}static fromDER(d){return M.fromBytes(q("sig",d),"der")}normalizeS(){return this.hasHighS()?new M(this.r,i.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return J(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return J(this.toBytes("compact"))}}const ut=r.bits2int||function(d){if(d.length>8192)throw new Error("input is too large");const w=It(d),E=d.length*8-l;return E>0?w>>BigInt(E):w},it=r.bits2int_modN||function(d){return i.create(ut(d))},yt=Ut(l);function Kt(h){return Lr("num < 2^"+l,h,nt,yt),i.toBytes(h)}function wt(h,d){return dt(h,void 0,"message"),d?dt(e(h),void 0,"prehashed message"):h}function R(h,d,w){if(["recovered","canonical"].some(T=>T in w))throw new Error("sign() legacy options not supported");const{lowS:E,prehash:S,extraEntropy:_}=ve(w,b);h=wt(h,S);const x=it(h),k=gt(i,d),I=[Kt(k),Kt(x)];if(_!=null&&_!==!1){const T=_===!0?n(f.secretKey):_;I.push(q("extraEntropy",T))}const $=X(...I),L=x;function N(T){const U=ut(T);if(!i.isValidNot0(U))return;const Z=i.inv(U),H=t.BASE.multiply(U).toAffine(),K=i.create(H.x);if(K===nt)return;const Zt=i.create(Z*i.create(L+K*k));if(Zt===nt)return;let Fe=(H.x===K?0:2)|Number(H.y&xt),Ge=Zt;return E&&A(Zt)&&(Ge=i.neg(Zt),Fe^=1),new M(K,Ge,Fe)}return{seed:$,k2sig:N}}function Vt(h,d,w={}){h=q("message",h);const{seed:E,k2sig:S}=R(h,d,w);return Or(e.outputLen,i.BYTES,s)(E,S)}function ft(h){let d;const w=typeof h=="string"||se(h),E=!w&&h!==null&&typeof h=="object"&&typeof h.r=="bigint"&&typeof h.s=="bigint";if(!w&&!E)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(E)d=new M(h.r,h.s);else if(w){try{d=M.fromBytes(q("sig",h),"der")}catch(S){if(!(S instanceof tt.Err))throw S}if(!d)try{d=M.fromBytes(q("sig",h),"compact")}catch{return!1}}return d||!1}function C(h,d,w,E={}){const{lowS:S,prehash:_,format:x}=ve(E,b);if(w=q("publicKey",w),d=wt(q("message",d),_),"strict"in E)throw new Error("options.strict was renamed to lowS");const k=x===void 0?ft(h):M.fromBytes(q("sig",h),x);if(k===!1)return!1;try{const I=t.fromBytes(w);if(S&&k.hasHighS())return!1;const{r:$,s:L}=k,N=it(d),T=i.inv(L),U=i.create(N*T),Z=i.create($*T),H=t.BASE.multiplyUnsafe(U).add(I.multiplyUnsafe(Z));return H.is0()?!1:i.create(H.x)===$}catch{return!1}}function g(h,d,w={}){const{prehash:E}=ve(w,b);return d=wt(d,E),M.fromBytes(h,"recovered").recoverPublicKey(d).toBytes()}return Object.freeze({keygen:m,getPublicKey:p,getSharedSecret:y,utils:u,lengths:f,Point:t,sign:Vt,verify:C,recoverPublicKey:g,Signature:M,hash:e})}function ts(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},r=t.Fp;let n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(i=>Math.ceil(i/2)))):void 0;const s=qt(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),o={Fp:r,Fn:s,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:o}}function es(t){const{CURVE:e,curveOpts:r}=ts(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:r,hash:t.hash,ecdsaOpts:n}}function ns(t,e){const r=e.Point;return Object.assign({},e,{ProjectivePoint:r,CURVE:Object.assign({},t,Ln(r.Fn.ORDER,r.Fn.BITS))})}function rs(t){const{CURVE:e,curveOpts:r,hash:n,ecdsaOpts:s}=es(t),o=Wr(e,r),i=Qr(o,n,s);return ns(t,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ss(t,e){const r=n=>rs({...t,hash:n});return{...r(e),create:r}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const St={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},os={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},is=BigInt(0),sn=BigInt(1),Ne=BigInt(2);function cs(t){const e=St.p,r=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),l=BigInt(88),m=t*t*t%e,p=m*m*t%e,y=F(p,r,e)*p%e,u=F(y,r,e)*p%e,f=F(u,Ne,e)*m%e,b=F(f,s,e)*f%e,v=F(b,o,e)*b%e,A=F(v,a,e)*v%e,O=F(A,l,e)*A%e,Nt=F(O,a,e)*v%e,M=F(Nt,r,e)*p%e,ut=F(M,i,e)*b%e,it=F(ut,n,e)*m%e,yt=F(it,Ne,e);if(!Qt.eql(Qt.sqr(yt),t))throw new Error("Cannot find square root");return yt}const Qt=qt(St.p,{sqrt:cs}),Ue=ss({...St,Fp:Qt,lowS:!0,endo:os},Jt),on={};function te(t,...e){let r=on[t];if(r===void 0){const n=Jt(oe(t));r=X(n,n),on[t]=r}return Jt(X(r,...e))}const qe=t=>t.toBytes(!0).slice(1),Rt=Ue.Point,Pe=t=>t%Ne===is;function Ce(t){const{Fn:e,BASE:r}=Rt,n=gt(e,t),s=r.multiply(n);return{scalar:Pe(s.y)?n:e.neg(n),bytes:qe(s)}}function Kn(t){const e=Qt;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x ≥ p");const r=e.create(t*t),n=e.create(r*t+BigInt(7));let s=e.sqrt(n);Pe(s)||(s=e.neg(s));const o=Rt.fromAffine({x:t,y:s});return o.assertValidity(),o}const Lt=It;function Vn(...t){return Rt.Fn.create(Lt(te("BIP0340/challenge",...t)))}function cn(t){return Ce(t).bytes}function as(t,e,r=ie(32)){const{Fn:n}=Rt,s=q("message",t),{bytes:o,scalar:i}=Ce(e),a=q("auxRand",r,32),l=n.toBytes(i^Lt(te("BIP0340/aux",a))),m=te("BIP0340/nonce",l,o,s),{bytes:p,scalar:y}=Ce(m),u=Vn(p,o,s),f=new Uint8Array(64);if(f.set(p,0),f.set(n.toBytes(n.create(y+u*i)),32),!Zn(f,s,o))throw new Error("sign: Invalid signature produced");return f}function Zn(t,e,r){const{Fn:n,BASE:s}=Rt,o=q("signature",t,64),i=q("message",e),a=q("publicKey",r,32);try{const l=Kn(Lt(a)),m=Lt(o.subarray(0,32));if(!Ie(m,sn,St.p))return!1;const p=Lt(o.subarray(32,64));if(!Ie(p,sn,St.n))return!1;const y=Vn(n.toBytes(m),qe(l),i),u=s.multiplyUnsafe(p).add(l.multiplyUnsafe(n.neg(y))),{x:f,y:b}=u.toAffine();return!(u.is0()||!Pe(b)||f!==m)}catch{return!1}}const jn=(()=>{const r=(s=ie(48))=>Hn(s,St.n);Ue.utils.randomSecretKey;function n(s){const o=r(s);return{secretKey:o,publicKey:cn(o)}}return{keygen:n,getPublicKey:cn,sign:as,verify:Zn,Point:Rt,utils:{randomSecretKey:r,randomPrivateKey:r,taggedHash:te,lift_x:Kn,pointToBytes:qe,numberToBytesBE:ce,bytesToNumberBE:It,mod:G},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),B=t=>document.getElementById(t),c={settings:null,currentRoom:"#test",rooms:[],roomCounts:{},attachments:[],maxImageKB:300,maxPayloadKB:450,peers:new Map,sessions:new Map,pendingOffers:new Map,lastRelayNotice:"",lastRelayDetail:"",pendingRelayDetail:!1,relayPollId:null,relayItems:[],messagePollId:null,lastMessageId:new Map},rt=new Map,ee=new Map,an=new Set;let ae="echochan-web";const At=new Map,Ke=async(t,e)=>(At.has(t)||At.set(t,new Set),At.get(t).add(e),()=>{var r;return(r=At.get(t))==null?void 0:r.delete(e)});function Ae(t,e){const r=At.get(t);r&&r.forEach(n=>n({payload:e}))}const z=async(t,e={})=>{switch(t){case"get_state":return Ts();case"save_settings":return Hs(e.settings);case"add_room":return Ms(e.room);case"remove_room":return $s(e.room);case"get_room_messages":return Us(e.room);case"connect_relays":return qs();case"send_message":return Ps(e.message);case"send_signal":return Ks(e.signal);case"check_tor":throw new Error("Tor is not supported in the web build.");default:throw new Error(`Unknown command: ${t}`)}},ln=B("room-list"),_e=B("command-input"),st=B("message-input"),D=B("messages"),un=B("inline-previews"),ls=B("relay-status"),Tt=B("current-room"),us=B("connect-btn"),fs=B("send-btn"),ds=B("attach-btn"),ms=B("p2p-btn"),hs=B("settings-btn"),vt=B("settings-modal"),Dt=vt==null?void 0:vt.querySelector(".modal-content"),gs=B("settings-close"),ps=B("settings-save"),ys=B("relay-test"),ws=B("relay-defaults"),bs=B("tor-check"),Es=B("relay-prune"),Be=B("relay-status-list"),Ht=B("confirm-modal"),xs=B("confirm-title"),vs=B("confirm-body"),zn=B("confirm-ok"),_s=B("confirm-cancel"),Ve=B("nick-input"),kt=B("relay-input"),Dn=B("stun-input"),Yn=B("turn-input"),Fn=B("turn-username"),Gn=B("turn-password"),Jn=B("max-image-kb"),Wn=B("max-payload-kb"),Xn=B("tor-toggle"),Qn=B("proxy-input"),tr=B("max-p2p-mb"),er=B("p2p-timeout"),nr=B("p2p-recent-min"),rr=B("p2p-max-sessions"),Le=B("file-input"),Oe=B("p2p-file-input"),Ot=B("target-select"),Bs=B("p2p-inbox"),Ct=B("relay-errors"),Ss=B("toast-stack"),le=B("image-viewer"),sr=B("viewer-image"),fn=16*1024,ks=44;let Yt=null;const or=["wss://relay.damus.io","wss://nos.lol","wss://relay.nostr.net","wss://relay.nos.social","wss://www.nostr.ltd"];function Et(t,e="info",r=6e3){if(!t)return;const n=document.createElement("div");n.className=`toast ${e==="error"?"error":""}`.trim(),n.textContent=t,Ss.appendChild(n),setTimeout(()=>{n.remove()},r)}function ue(t){const e=[];for(const r of t){const n=String(r||"").trim();if(!n)continue;const o=n.split(/\s+/)[0].replace(/[;,]+$/,"");o.startsWith("wss://")&&e.push(o)}return e}function Y(t){const e=String(t||"").trim();return e?e.startsWith("#")?e:`#${e}`:""}function Ze(t){const e=[],r=new Set;for(const n of t||[]){const s=Y(n);s&&!r.has(s)&&(r.add(s),e.push(s))}return e}function dn(){return{nick:"Echidna",relays:[...or],rooms:["#echo"],max_image_kb:300,max_payload_kb:450,stun_urls:["stun:stun.l.google.com:19302"],turn_urls:[],turn_username:"",turn_password:"",max_p2p_mb:5,p2p_timeout_sec:15,p2p_recent_minutes:10,p2p_max_sessions:2,nostr_pubkey:"",nostr_privkey:"",client_id:"",use_tor:!1,proxy_url:""}}function Is(){const t=Ue.utils.randomPrivateKey(),e=jn.getPublicKey(t);return{priv:J(t),pub:J(e)}}function ir(t){if(!t.nostr_privkey||!t.nostr_pubkey){const e=Is();t.nostr_privkey=e.priv,t.nostr_pubkey=e.pub}t.client_id=t.nostr_pubkey}function Rs(){const t=localStorage.getItem("echochan_settings");let e=dn();if(t)try{e={...e,...JSON.parse(t)}}catch{e=dn()}return e.relays=ue(e.relays||[]),e.rooms=Ze(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),ir(e),e}function je(t){localStorage.setItem("echochan_settings",JSON.stringify(t))}function cr(t){return`echochan-${(t||"").slice(0,8)||"web"}`}function Ns(t){const e=JSON.stringify(t.attachments||[]),r=`${t.room}${t.nick}${t.ts}${t.text}${e}`,n=yn(oe(r));return J(n)}function Cs(t,e,r,n,s){const o=JSON.stringify([0,t,e,r,n,s]),i=yn(oe(o));return J(i)}async function ar(t,e,r,n,s){const o=t.nostr_pubkey,i=Cs(o,s,e,r,n),a=await jn.sign(_t(i),_t(t.nostr_privkey)),l=J(a);return{id:i,pubkey:o,created_at:s,kind:e,tags:r,content:n,sig:l}}function ze(t){return t.trim().replace(/^#/,"")}function lr(){const e=(c.settings.rooms||[]).map(n=>ze(n));return e.length?JSON.stringify(["REQ",ae,{kinds:[1,42],"#t":e}]):null}function As(){return JSON.stringify(["CLOSE",ae])}function et(){const t=Array.from(rt.values()).map(s=>({url:s.url,state:s.status,last_error:s.lastError||null})),e=t.filter(s=>s.state==="connected").length,r=t.filter(s=>s.state==="error").length,n={total:t.length,connected:e,errors:r,items:t};return Ae("relay-status",n),n}function Ls(){var r;const t=ue(c.settings.relays||[]),e=new Set(t);for(const[n,s]of rt.entries())e.has(n)||((r=s.ws)==null||r.close(),rt.delete(n));for(const n of t)rt.has(n)||rt.set(n,{url:n,status:"connecting",lastError:null,backoff:1e3,ws:null,timer:null}),ur(n);return et()}function ur(t){const e=rt.get(t);if(e&&!(e.ws&&(e.ws.readyState===WebSocket.OPEN||e.ws.readyState===WebSocket.CONNECTING))){e.status="connecting",e.lastError=null,et();try{const r=new WebSocket(t);e.ws=r,r.onopen=()=>{e.status="connected",e.lastError=null,e.backoff=1e3;const n=lr();n&&r.send(n),et()},r.onmessage=n=>{typeof n.data=="string"&&Os(n.data,t)},r.onerror=()=>{e.status="error",e.lastError=e.lastError||"WebSocket error",et()},r.onclose=()=>{e.status="reconnecting",et();const n=Math.min(e.backoff,3e4);e.backoff=Math.min(e.backoff*2,3e4),clearTimeout(e.timer),e.timer=setTimeout(()=>ur(t),n)}}catch(r){e.status="error",e.lastError=String(r),et()}}}function ne(t){rt.forEach(e=>{e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(t)})}function De(){const t=As();ne(t);const e=lr();e&&ne(e)}function Os(t,e){let r;try{r=JSON.parse(t)}catch{return}if(!Array.isArray(r)||!r.length)return;const n=r[0];if(n==="NOTICE"){const l=r[1]||"",m=rt.get(e);m&&(m.lastError=l||"NOTICE",m.status=m.status==="connected"?"connected":"error",et());return}if(n==="OK"){if(!(r[2]!==!1)){const m=r[3]||"event rejected",p=rt.get(e);p&&(p.lastError=m,et())}return}if(n!=="EVENT"||r.length<3)return;const s=r[2];if(!s||s.kind!==1&&s.kind!==42)return;let o;try{o=JSON.parse(s.content)}catch{return}if(!o||typeof o!="object")return;if(o.type==="signal"){const l={type:"signal",room:Y(o.room||"")||mn(s.tags),from:o.from||s.pubkey,to:o.to||null,sid:o.sid,kind:o.kind,sdp:o.sdp||null,candidate:o.candidate||null,ts:o.ts||s.created_at*1e3};Ae("signal-message",l);return}if(o.type!=="message")return;const i=Y(o.room||"")||mn(s.tags);if(!i)return;const a={type:"message",room:i,nick:o.nick||`npub:${(s.pubkey||"").slice(0,8)}`,client_id:o.client_id||s.pubkey,ts:o.ts||s.created_at*1e3,text:o.text||"",attachments:Array.isArray(o.attachments)?o.attachments:[],id:o.id||s.id,action:!!o.action};fr(a)&&Ae("new-message",a)}function mn(t=[]){for(const e of t)if(e&&e[0]==="t"&&e[1])return Y(e[1]);return""}function fr(t){if(!t||!t.id||an.has(t.id))return!1;an.add(t.id);const e=ee.get(t.room)||[];return e.push(t),e.length>500&&e.shift(),ee.set(t.room,e),!0}async function Ts(){const t={};return ee.forEach((e,r)=>{t[r]=e.length}),{settings:c.settings,counts:t,relay_summary:et()}}async function Hs(t){const e={...c.settings,...t};e.relays=ue(e.relays||[]),e.rooms=Ze(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),ir(e),c.settings=e,ae=cr(e.nostr_pubkey),je(e),De()}async function Ms(t){const e=Y(t);e&&(c.settings.rooms.includes(e)||(c.settings.rooms.push(e),je(c.settings),De()))}async function $s(t){const e=Y(t);if(e){if(c.settings.rooms.length<=1)throw new Error("At least one room must remain.");c.settings.rooms=c.settings.rooms.filter(r=>r!==e),je(c.settings),De()}}async function Us(t){const e=Y(t);return ee.get(e)||[]}async function qs(){return Ls()}async function Ps(t){var a;if(((a=t.attachments)==null?void 0:a.length)>2)throw new Error("Only 2 inline images allowed.");const e=Y(t.room),r={type:"message",room:e,nick:t.nick,client_id:c.settings.nostr_pubkey,ts:Date.now(),text:t.text,attachments:t.attachments||[],id:"",action:!!t.action};r.id=Ns(r);const n=JSON.stringify(r),s=[["t",ze(e)]],o=await ar(c.settings,1,s,n,Math.floor(r.ts/1e3)),i=JSON.stringify(["EVENT",o]);if(i.length>(c.settings.max_payload_kb||450)*1024)throw new Error("Payload exceeds max_payload_kb limit.");return fr(r)&&ne(i),r}async function Ks(t){const e={type:"signal",room:Y(t.room),from:t.from||c.settings.nostr_pubkey,to:t.to||null,sid:t.sid,kind:t.kind,sdp:t.sdp||null,candidate:t.candidate||null,ts:Date.now()},r=JSON.stringify(e),n=[["t",ze(e.room)]],s=await ar(c.settings,1,n,r,Math.floor(e.ts/1e3)),o=JSON.stringify(["EVENT",s]);ne(o)}function fe(){return Date.now()}function P(t){ls.textContent=t}function Vs({title:t,body:e,okText:r}){return new Promise(n=>{Yt=n,xs.textContent=t,vs.textContent=e||"Are you sure?",zn.textContent=r,Ht.classList.remove("hidden")})}function de(t){Yt&&(Yt(t),Yt=null),Ht.classList.add("hidden")}function dr(){st.style.height="auto";const t=Math.max(st.scrollHeight,ks);st.style.height=`${t}px`}function Zs(t){const e=new Date(t);return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function js(){const t=new Uint8Array(12);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function ot(){ln.innerHTML="",c.rooms.forEach(t=>{const e=document.createElement("div");e.className="room"+(t===c.currentRoom?" active":"");const r=document.createElement("span");r.textContent=t;const n=document.createElement("span");n.className="count",n.textContent=c.roomCounts[t]||0;const s=document.createElement("button");s.className="room-remove",s.textContent="×",s.title="Remove room",s.addEventListener("click",async o=>{if(o.stopPropagation(),c.rooms.length<=1){P("At least one room must remain.");return}await Vs({title:"Remove room",body:`Remove room ${t}?`,okText:"Remove"})&&(await z("remove_room",{room:t}),c.rooms=c.rooms.filter(a=>a!==t),c.currentRoom===t&&(c.currentRoom=c.rooms[0],Tt.textContent=c.currentRoom,await Mt(c.currentRoom)),ot(),lt(`Left ${t}.`))}),e.append(r,n,s),e.addEventListener("click",async()=>{c.currentRoom=t,Tt.textContent=t,ot(),await Mt(t)}),ln.appendChild(e)})}function mr(){Ot.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="All",Ot.appendChild(t);const e=Array.from(c.peers.values()).sort((r,n)=>r.nick.localeCompare(n.nick));for(const r of e){const n=document.createElement("option");n.value=r.id,n.textContent=`${r.nick} · ${r.id.slice(0,8)}`,Ot.appendChild(n)}}function hr(t){if(D.innerHTML="",!t.length){const e=document.createElement("div");e.className="empty-state",e.textContent="No messages yet. Try /join #room or type a message.",D.appendChild(e)}if(t.forEach(e=>Pt(e)),D.scrollTop=D.scrollHeight,t.length){const e=t[t.length-1];e&&e.id&&c.lastMessageId.set(c.currentRoom,e.id)}}function lt(t){const e={nick:"system",ts:fe(),text:t,action:!1,attachments:[],system:!0};Pt(e),D.scrollTop=D.scrollHeight}function Pt(t){const e=document.createElement("div");e.className=t.system?"message system":"message";const r=document.createElement("div");r.className=t.attachments&&t.attachments.length?"message-body has-media":"message-body";const n=document.createElement("div");n.className="meta",n.textContent=`${t.nick} · ${Zs(t.ts)}`;const s=document.createElement("div");s.className="text",s.textContent=t.action?`* ${t.nick} ${t.text}`:t.text;const o=document.createElement("div");if(o.className="message-content",o.append(n,s),r.appendChild(o),t.attachments&&t.attachments.length){const i=document.createElement("div");i.className="attachments",t.attachments.forEach(a=>{const l=document.createElement("img");l.src=a.data,l.alt="attachment",l.addEventListener("click",()=>zs(a.data)),i.appendChild(l)}),r.insertBefore(i,o)}e.appendChild(r),D.appendChild(e),t&&t.id&&c.lastMessageId.set(t.room||c.currentRoom,t.id)}function zs(t){t&&(sr.src=t,le.classList.remove("hidden"))}function gr(){le.classList.add("hidden"),sr.src=""}function pr(){un.innerHTML="",c.attachments.forEach(t=>{const e=document.createElement("img");e.src=t.data,un.appendChild(e)})}function Ds(t){const e=JSON.stringify(t);return new TextEncoder().encode(e).length/1024}async function Ys(){c.settings=Rs(),ae=cr(c.settings.nostr_pubkey);const t=await z("get_state",{});c.settings=t.settings;const e=Ze(t.settings.rooms);c.rooms=e,c.roomCounts=t.counts||{},c.currentRoom=c.rooms[0]||"#test",c.maxImageKB=t.settings.max_image_kb,c.maxPayloadKB=t.settings.max_payload_kb,Ve.value=t.settings.nick,kt.value=t.settings.relays.join(`
`),Jn.value=t.settings.max_image_kb,Wn.value=t.settings.max_payload_kb,Dn.value=t.settings.stun_urls.join(`
`),Xn.checked=t.settings.use_tor||!1,Qn.value=t.settings.proxy_url||"",Yn.value=t.settings.turn_urls.join(`
`),Fn.value=t.settings.turn_username||"",Gn.value=t.settings.turn_password||"",tr.value=t.settings.max_p2p_mb||5,er.value=t.settings.p2p_timeout_sec||15,nr.value=t.settings.p2p_recent_minutes||10,rr.value=t.settings.p2p_max_sessions||2,Tt.textContent=c.currentRoom,ot(),mr(),await Mt(c.currentRoom),me(t.relay_summary),JSON.stringify(e)!==JSON.stringify(t.settings.rooms)&&(c.settings.rooms=e,await z("save_settings",{settings:c.settings})),lt(`Relays configured: ${c.settings.relays.length}`),Fs(),Gs()}function Fs(){c.relayPollId||(c.relayPollId=setInterval(async()=>{try{const t=await z("get_state",{});t&&t.relay_summary&&me(t.relay_summary)}catch{}},4e3))}function Gs(){c.messagePollId||(c.messagePollId=setInterval(async()=>{if(c.currentRoom)try{const t=await z("get_room_messages",{room:c.currentRoom}),e=t.length?t[t.length-1]:null,r=(e==null?void 0:e.id)||"",n=c.lastMessageId.get(c.currentRoom)||"";(r!==n||t.length!==(c.roomCounts[c.currentRoom]||0))&&(c.roomCounts[c.currentRoom]=t.length,hr(t),Ye(t),ot())}catch{}},2e3))}function me(t){if(!t)return;const e=t.total??(t.items?t.items.length:0),r=t.connected??0,n=t.errors??0;c.relayItems=t.items||[],e>0&&r===0&&n===0?P(`Connecting to ${e} relays...`):P(`Connected to ${r}/${e} relays, ${n} errors`),Xs(t.items||[]),Qs(t.items||[]),Js(t),c.pendingRelayDetail&&Ws(t)}function Js(t){const e=[];t.total===0?e.push("No relays configured. Open Settings and add wss:// relays."):t.connected===0&&e.push("No relay connections yet. Check relay errors in Settings.");const r=(t.items||[]).filter(s=>s.last_error);if(r.length)for(const s of r)s.last_error?e.push(`${s.url} error: ${s.last_error}`):e.push(`${s.url} error`);if(!e.length)return;const n=e.join(" ");n!==c.lastRelayNotice&&(c.lastRelayNotice=n,Et(n,"error"))}function Ws(t){const e=t.items||[];if(!e.length)return;const n=`Relay status: ${e.map(s=>s.last_error?`${s.state}: ${s.url} (${s.last_error})`:`${s.state}: ${s.url}`).join(" | ")}`;n!==c.lastRelayDetail&&(c.lastRelayDetail=n,Et(n,"info",5e3),c.pendingRelayDetail=!1)}function Xs(t){const e=Dt&&!vt.classList.contains("hidden"),r=e?Dt.scrollTop:0;if(Be.innerHTML="",!t.length){const n=document.createElement("div");n.textContent="No relay status yet. Click Test relays.",Be.appendChild(n),e&&(Dt.scrollTop=r);return}t.forEach(n=>{const s=document.createElement("div");s.className="relay-status-item";const o=document.createElement("div");o.textContent=n.url;const i=document.createElement("div");i.className=`state ${n.state}`,i.textContent=n.state;const a=document.createElement("button");if(a.textContent="Remove",a.addEventListener("click",async()=>{const l=c.settings.relays.filter(m=>m!==n.url);if(!l.length){P("At least one relay must remain.");return}kt.value=l.join(`
`),await ge({close:!1})}),s.append(o,i,a),n.last_error){const l=document.createElement("div");l.className="error",l.textContent=n.last_error,s.appendChild(l)}Be.appendChild(s)}),e&&(Dt.scrollTop=r)}function Qs(t){const e=t.filter(n=>n.last_error);if(Ct.innerHTML="",!e.length){Ct.classList.add("hidden");return}Ct.classList.remove("hidden");const r=document.createElement("div");r.className="title",r.textContent="Relay errors",Ct.appendChild(r),e.forEach(n=>{const s=document.createElement("div");s.className="item",s.textContent=n.last_error?`${n.url} — ${n.last_error}`:`${n.url} — error`,Ct.appendChild(s)})}async function Mt(t){const e=await z("get_room_messages",{room:t});c.roomCounts[t]=e.length,hr(e),Ye(e),ot()}async function he(){var s;if(P("Connecting..."),Et("Connecting to relays...","info",3e3),(s=c.settings)!=null&&s.use_tor){const o=c.settings.proxy_url||"socks5://127.0.0.1:9150";Et(`Using SOCKS5 proxy: ${o}`,"info",4e3)}c.pendingRelayDetail=!0;const t=await z("connect_relays",{});me(t);const e=t.total??(t.items?t.items.length:0),r=t.connected??0,n=t.errors??0;e>0&&r===0&&n===0?Et(`Connecting to ${e} relays...`,"info",3e3):Et(`Connected to ${r}/${e} relays, ${n} errors.`,"info",4e3)}async function yr(t){const e=t.trim();if(e){if(e.startsWith("/join ")){const r=Y(e.replace("/join","").trim());if(!r)return;c.rooms.includes(r)||(c.rooms.push(r),ot(),await z("add_room",{room:r})),c.currentRoom=r,Tt.textContent=r,lt(`Joined ${r}.`),await Mt(r);return}if(e.startsWith("/leave ")){const r=Y(e.replace("/leave","").trim());if(!r)return;if(c.rooms.length<=1){P("At least one room must remain.");return}if(!c.rooms.includes(r)){P("Room not found.");return}await z("remove_room",{room:r}),c.rooms=c.rooms.filter(n=>n!==r),c.currentRoom===r&&(c.currentRoom=c.rooms[0],Tt.textContent=c.currentRoom,await Mt(c.currentRoom)),ot(),lt(`Left ${r}.`);return}if(e.startsWith("/nick ")){const r=e.replace("/nick","").trim();if(!r)return;c.settings.nick=r,Ve.value=r,await z("save_settings",{settings:c.settings}),lt(`Nick changed to ${r}.`);return}}}async function wr(t){const e=t.trim();if(!e)return;if(e.startsWith("/join ")||e.startsWith("/nick ")||e.startsWith("/leave ")){await yr(e),st.value="";return}let r=!1,n=e;e.startsWith("/me ")&&(r=!0,n=e.replace("/me","").trim());const s={type:"message",room:Y(c.currentRoom),nick:c.settings.nick,ts:Date.now(),text:n,attachments:c.attachments,id:"0".repeat(64),action:r};if(Ds(s)>c.maxPayloadKB){P(`Payload exceeds ${c.maxPayloadKB}KB limit.`);return}try{const o=await z("send_message",{message:{room:Y(c.currentRoom),nick:c.settings.nick,text:n,attachments:c.attachments,action:r}});c.attachments=[],pr(),st.value="",c.roomCounts[c.currentRoom]=(c.roomCounts[c.currentRoom]||0)+1,Pt(o),ot(),D.scrollTop=D.scrollHeight}catch(o){P(String(o))}}async function to(t,e,r){const n=await createImageBitmap(t),s=Math.max(n.width,n.height),o=Math.min(1,e/s),i=[1,.9,.8,.7,.6],a=[.75,.6,.45,.3],l=document.createElement("canvas"),m=l.getContext("2d");for(const p of i){const y=o*p,u=Math.max(1,Math.round(n.width*y)),f=Math.max(1,Math.round(n.height*y));l.width=u,l.height=f,m.clearRect(0,0,u,f),m.drawImage(n,0,0,u,f);for(const b of a){const v=l.toDataURL("image/webp",b),A=v.split(",")[1]||"",O=Math.floor(A.length*.75);if(O<=r*1024)return{kind:"inline",mime:"image/webp",data:v,w:u,h:f,size:O}}}throw new Error("Image too large after compression.")}async function eo(t){for(const e of t){if(c.attachments.length>=2){P("Only 2 inline images allowed.");break}try{const r=await to(e,1280,c.maxImageKB);c.attachments.push(r),pr()}catch(r){P(String(r))}}}function no(){vt.classList.remove("hidden")}function br(){vt.classList.add("hidden")}async function ge({close:t=!0}={}){const e=ue(kt.value.split(`
`)),r=Dn.value.split(`
`).map(s=>s.trim()).filter(s=>s.length),n=Yn.value.split(`
`).map(s=>s.trim()).filter(s=>s.length);c.settings.nick=Ve.value.trim()||c.settings.nick,c.settings.relays=e,kt.value=e.join(`
`),c.settings.max_image_kb=Number(Jn.value)||c.maxImageKB,c.settings.max_payload_kb=Number(Wn.value)||c.maxPayloadKB,c.settings.stun_urls=r,c.settings.use_tor=Xn.checked,c.settings.proxy_url=Qn.value.trim(),c.settings.turn_urls=n,c.settings.turn_username=Fn.value||"",c.settings.turn_password=Gn.value||"",c.settings.max_p2p_mb=Number(tr.value)||5,c.settings.p2p_timeout_sec=Number(er.value)||15,c.settings.p2p_recent_minutes=Number(nr.value)||10,c.settings.p2p_max_sessions=Number(rr.value)||2,c.maxImageKB=c.settings.max_image_kb,c.maxPayloadKB=c.settings.max_payload_kb,await z("save_settings",{settings:c.settings}),t&&br(),await he()}function Er(){const t=[];return c.settings.stun_urls&&c.settings.stun_urls.length&&t.push({urls:c.settings.stun_urls}),c.settings.turn_urls&&c.settings.turn_urls.length&&t.push({urls:c.settings.turn_urls,username:c.settings.turn_username||void 0,credential:c.settings.turn_password||void 0}),{iceServers:t}}function xr(){return c.sessions.size}function ro(t){const e=c.peers.get(t);return e?fe()-e.lastSeen<=(c.settings.p2p_recent_minutes||10)*60*1e3:!1}function Ye(t){for(const e of t){if(!e.client_id)continue;const r=e.client_id,n=c.peers.get(r),s=e.nick||r.slice(0,8),o=e.ts||fe();(!n||n.lastSeen<o)&&c.peers.set(r,{id:r,nick:s,lastSeen:o})}mr()}function vr(t,e){const r=c.settings.p2p_timeout_sec||15,n={sid:t,mode:e,pc:null,dc:null,meta:null,receivedChunks:[],receivedBytes:0,expectedSize:0,timeout:null};return n.timeout=setTimeout(()=>{$t(t,"P2P failed (timeout). Use inline instead.")},r*1e3),c.sessions.set(t,n),n}function $t(t,e){const r=c.sessions.get(t);r&&(clearTimeout(r.timeout),r.dc&&r.dc.close(),r.pc&&r.pc.close(),c.sessions.delete(t),e&&P(e))}async function re(t,e){const r={room:c.currentRoom,from:c.settings.nostr_pubkey||"",to:e.to||null,sid:e.sid,kind:t,sdp:e.sdp||null,candidate:e.candidate||null};await z("send_signal",{signal:r})}async function so(t){if(xr()>=(c.settings.p2p_max_sessions||2)){P("P2P session limit reached.");return}if(t.size>(c.settings.max_p2p_mb||5)*1024*1024){P("P2P file too large.");return}const e=js(),r=vr(e,"send"),n=new RTCPeerConnection(Er());r.pc=n;const s=n.createDataChannel("file");r.dc=s,s.binaryType="arraybuffer",s.onopen=async()=>{const i=await t.arrayBuffer(),a={kind:"file_meta",sid:e,name:t.name,mime:t.type||"application/octet-stream",size:t.size};s.send(JSON.stringify(a));let l=0;const m=new Uint8Array(i);for(;l<m.length;){const p=m.slice(l,l+fn);s.send(p),l+=fn}},s.onmessage=i=>{if(typeof i.data=="string")try{const a=JSON.parse(i.data);a.kind==="file_ack"&&a.sid===e&&$t(e,"P2P transfer completed.")}catch{return}},n.onicecandidate=async i=>{i.candidate&&await re("ice",{sid:e,to:Ot.value||null,candidate:{candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex}})};const o=await n.createOffer();await n.setLocalDescription(o),await re("offer",{sid:e,to:Ot.value||null,sdp:o.sdp})}function oo(t){const e=document.createElement("div");e.className="p2p-card";const r=document.createElement("div");r.textContent=`Incoming P2P image from ${t.from.slice(0,8)}`;const n=document.createElement("div");n.className="actions";const s=document.createElement("button");s.textContent="Accept";const o=document.createElement("button");o.textContent="Decline",n.append(s,o),e.append(r,n),Bs.appendChild(e),s.addEventListener("click",async()=>{e.remove(),await io(t)}),o.addEventListener("click",()=>{e.remove(),$t(t.sid,"P2P declined.")})}async function io(t){if(xr()>=(c.settings.p2p_max_sessions||2)){P("P2P session limit reached.");return}if(!ro(t.from)){P("P2P offer ignored (sender not recent).");return}const e=t.sid,r=vr(e,"recv"),n=new RTCPeerConnection(Er());r.pc=n,n.ondatachannel=o=>{const i=o.channel;r.dc=i,i.binaryType="arraybuffer",i.onmessage=a=>co(r,t.from,a.data)},n.onicecandidate=async o=>{o.candidate&&await re("ice",{sid:e,to:t.from,candidate:{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex}})},await n.setRemoteDescription({type:"offer",sdp:t.sdp});const s=await n.createAnswer();await n.setLocalDescription(s),await re("answer",{sid:e,to:t.from,sdp:s.sdp})}function co(t,e,r){if(typeof r=="string"){try{const s=JSON.parse(r);s.kind==="file_meta"&&s.sid===t.sid&&(t.meta=s,t.expectedSize=s.size,s.size>(c.settings.max_p2p_mb||5)*1024*1024&&$t(t.sid,"P2P file too large."))}catch{return}return}if(!t.meta)return;const n=new Uint8Array(r);if(t.receivedChunks.push(n),t.receivedBytes+=n.byteLength,t.receivedBytes>=t.expectedSize){const s=new Blob(t.receivedChunks,{type:t.meta.mime}),o=URL.createObjectURL(s),i={nick:e.slice(0,8),ts:fe(),text:"[P2P image]",action:!1,attachments:[{data:o}]};Pt(i),D.scrollTop=D.scrollHeight,t.dc&&t.dc.send(JSON.stringify({kind:"file_ack",sid:t.sid,ok:!0})),$t(t.sid,null)}}async function ao(t){if(t.room!==c.currentRoom)return;if(t.kind==="offer"){if(c.pendingOffers.has(t.sid))return;c.pendingOffers.set(t.sid,t),oo(t);return}const e=c.sessions.get(t.sid);if(e){if(t.kind==="answer"&&e.pc){await e.pc.setRemoteDescription({type:"answer",sdp:t.sdp});return}if(t.kind==="ice"&&e.pc&&t.candidate)try{await e.pc.addIceCandidate(t.candidate)}catch{return}}}us.addEventListener("click",he);hs.addEventListener("click",no);gs.addEventListener("click",br);ps.addEventListener("click",ge);ys.addEventListener("click",async()=>{await he()});ws.addEventListener("click",async()=>{kt.value=or.join(`
`),await ge({close:!1})});bs.addEventListener("click",async()=>{try{const t=await z("check_tor",{});lt(t?"Tor proxy is reachable.":"Tor is disabled. Enable Use Tor to test.")}catch(t){lt(`Tor check failed: ${String(t)}`)}});Es.addEventListener("click",async()=>{const t=new Set(c.relayItems.filter(r=>r.state==="error").map(r=>r.url));if(!t.size){P("No failing relays to remove.");return}const e=c.settings.relays.filter(r=>!t.has(r));if(!e.length){P("All relays would be removed.");return}kt.value=e.join(`
`),await ge({close:!1})});zn.addEventListener("click",()=>de(!0));_s.addEventListener("click",()=>de(!1));Ht.addEventListener("click",t=>{t.target===Ht&&de(!1)});le.addEventListener("click",()=>{gr()});ds.addEventListener("click",()=>Le.click());ms.addEventListener("click",()=>{Oe.click()});Oe.addEventListener("change",async t=>{var r;const e=(r=t.target.files)==null?void 0:r[0];e&&await so(e),Oe.value=""});Le.addEventListener("change",async t=>{const e=Array.from(t.target.files||[]);await eo(e),Le.value=""});_e.addEventListener("keydown",async t=>{t.key==="Enter"&&(await yr(_e.value),_e.value="")});fs.addEventListener("click",async()=>wr(st.value));st.addEventListener("keydown",async t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),await wr(st.value))});st.addEventListener("input",dr);document.addEventListener("keydown",t=>{t.key==="Escape"&&!Ht.classList.contains("hidden")&&de(!1),t.key==="Escape"&&!le.classList.contains("hidden")&&gr()});Ke("new-message",t=>{const e=t.payload;!e||!e.room||(c.roomCounts[e.room]||(c.roomCounts[e.room]=0),c.roomCounts[e.room]+=1,e.room===c.currentRoom&&(Pt(e),D.scrollTop=D.scrollHeight,Ye([e])),ot())});Ke("relay-status",t=>{me(t.payload)});Ke("signal-message",t=>{ao(t.payload).catch(()=>{})});Ys().then(he).catch(t=>P(String(t)));dr();
